{% extends "base.html" %}

{# ============================================================================== #}
{# 1. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ (Django ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ) #}
{# ============================================================================== #}
{% block content %}

    <div class="mb-3">
        {# ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º #}
        <p class="lead">ã‚ˆã†ã“ãã€{{ user.username }}ã•ã‚“ï¼</p>
    </div>

    <h1>ã‚¿ã‚¹ã‚¯ä¸€è¦§</h1>

    {# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€æ¤œç´¢ã€ã‚¿ã‚¹ã‚¯ä½œæˆãƒœã‚¿ãƒ³ã‚’æ°´å¹³ã«é…ç½®ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ #}
    <div class="d-flex justify-content-between align-items-start mb-3">
        
        {# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  (GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ) #}
        <form method="get" id="filter-form" class="d-flex flex-wrap align-items-center"> 
        
            {# æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
            <div class="input-group input-group-sm me-3 mb-2" style="width: 250px;">
                <input 
                    type="search" 
                    name="q" 
                    class="form-control" 
                    placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." 
                    aria-label="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"
                    {# ç¾åœ¨ã®æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ä¿æŒ #}
                    value="{{ current_search_query|default:'' }}"
                >
                <button class="btn btn-outline-secondary" type="submit">ğŸ”</button>
            </div>

            <span class="fw-bold me-3 mb-2">ãƒ•ã‚£ãƒ«ã‚¿:</span>

            {# ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ #}
            <div class="d-inline-block me-3 mb-2">
                <label for="category-select" class="form-label visually-hidden">ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿</label>
                <select 
                    class="form-select form-select-sm" 
                    name="category" 
                    id="category-select" 
                    {# å¤‰æ›´æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡ #}
                    onchange="document.getElementById('filter-form').submit();">
                    
                    <option value="">å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option> 
                    
                    {# ã‚«ãƒ†ã‚´ãƒª 'ãªã—' (CategoryãŒæœªè¨­å®šã®ã‚¿ã‚¹ã‚¯) ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ #}
                    <option value="none" {% if current_category_filter == 'none' %}selected{% endif %}>
                        ãªã—
                    </option>
                    
                    {# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º #}
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category_id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            {# é€²æ—çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ #}
            <div class="d-inline-block me-3 mb-2">
                <label for="status-select" class="form-label visually-hidden">é€²æ—çŠ¶æ³ã§ãƒ•ã‚£ãƒ«ã‚¿</label>
                <select 
                    class="form-select form-select-sm" 
                    name="status" 
                    id="status-select" 
                    {# å¤‰æ›´æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡ #}
                    onchange="document.getElementById('filter-form').submit();">
                    
                    <option value="">å…¨ã¦ã®é€²æ—çŠ¶æ³</option>
                    
                    {# Taskãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é¸æŠè‚¢ã‚’ãƒ«ãƒ¼ãƒ— #}
                    {% for status_id, status_name in status_choices %}
                        <option value="{{ status_id }}" {% if status_id|stringformat:"s" == current_status_filter %}selected{% endif %}>
                            {{ status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ #}
            <div class="d-inline-block me-3 mb-2">
                <label for="priority-select" class="form-label visually-hidden">å„ªå…ˆåº¦ã§ãƒ•ã‚£ãƒ«ã‚¿</label>
                <select 
                    class="form-select form-select-sm" 
                    name="priority" 
                    id="priority-select" 
                    {# å¤‰æ›´æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡ #}
                    onchange="document.getElementById('filter-form').submit();">
                    
                    <option value="">å…¨ã¦ã®å„ªå…ˆåº¦</option>
                    
                    {# Taskãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã•ã‚ŒãŸå„ªå…ˆåº¦ã®é¸æŠè‚¢ã‚’ãƒ«ãƒ¼ãƒ— #}
                    {% for priority_id, priority_name in priority_choices %}
                        <option value="{{ priority_id }}" {% if priority_id|stringformat:"s" == current_priority_filter %}selected{% endif %}>
                            {{ priority_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# ã‚½ãƒ¼ãƒˆæƒ…å ±ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã® hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
            {# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œå¾Œã‚‚ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«å¿…è¦ #}
            <input type="hidden" name="sort" value="{{ current_sort_key }}">
            <input type="hidden" name="order" value="{{ current_order }}">
        </form>

        {# ã‚¿ã‚¹ã‚¯ä½œæˆãƒœã‚¿ãƒ³ (å³ç«¯) #}
        <div class="ms-auto">
            <a href="{% url 'task_create' %}" class="btn btn-primary text-nowrap">+ æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</a>
        </div>
        
    </div>

    
    {# 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/æ¤œç´¢ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¢ãƒ©ãƒ¼ãƒˆ #}
    {# ã‚«ãƒ†ã‚´ãƒª/é€²æ—çŠ¶æ³/å„ªå…ˆåº¦/æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«è¡¨ç¤º #}
    {% if current_category_filter or current_status_filter or current_priority_filter or current_search_query %}
        
        {# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è§£é™¤ç”¨ã®URLã‚’ä½œæˆ #}
        {% with clear_filter_url='?sort='|add:current_sort_key|add:'&order='|add:current_order %}
            
            <div class="alert alert-warning small py-1 px-3 d-flex align-items-center">
                <span class="me-3 fw-bold">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/æ¤œç´¢ä¸­</span>
                
                {# å…¨ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è§£é™¤ã—ã€ã‚½ãƒ¼ãƒˆæƒ…å ±ã®ã¿ã‚’ç¶­æŒã™ã‚‹ãƒªãƒ³ã‚¯ #}
                <a href="{% url 'home' %}{{ clear_filter_url }}" class="text-decoration-none text-dark">(è§£é™¤)</a>
            </div>
        {% endwith %}
    {% endif %}
    <hr>

    {# ============================================================================== #}
    {# 3. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³CSS: é€²æ—çŠ¶æ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© #}
    {# ============================================================================== #}
    <style>
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®selectã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .status-select {
            padding: 0.25rem 0.5rem 0.25rem 0.5rem;
            padding-right: 1.5rem !important; 
            
            font-size: 0.85rem !important;
            background-color: transparent !important;
            color: #212529; 
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            line-height: 1.5;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            cursor: pointer;
            box-shadow: none !important;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            text-align: center;
        }
        
        /* å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²ã‚¯ãƒ©ã‚¹ã‚’å®šç¾© */
        
        /* 1. æœªç€æ‰‹ (Danger: èµ¤) */
        .bg-danger-select { 
            background-color: #dc3545 !important;
            color: white; 
        }
        
        /* 2. é€²è¡Œä¸­ (Warning: é»„) */
        .bg-warning-select { 
            background-color: #ffc107 !important; 
            color: #212529; 
        } 
        
        /* 3. å®Œäº† (Success: ç·‘) */
        .bg-success-select { 
            background-color: #198754 !important; 
            color: white; 
        }

        .status-select option {
            text-align: left !important;
            background-color: white !important;
            color: #212529 !important;
            font-weight: normal; 
            font-size: 0.85rem !important;
        }
    
        /* é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚ãƒªã‚»ãƒƒãƒˆ */
        .status-select option:checked {
            background-color: #0d6efd !important; 
            color: white !important;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ªè¦ç´ ã«ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        .select-wrapper {
            position: relative;
            display: inline-block;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’å³ç«¯ã«é…ç½® */
        .select-wrapper::after {
            content: 'â–¼'; 
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            pointer-events: none; 
            font-size: 0.7em;
            line-height: 1;
            color: inherit; 
        }

        .table-striped tbody td {
            background-color: transparent !important;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«åˆ—ã®å¹…ã‚’èª¿æ•´ã™ã‚‹CSS */
        /* ã‚¿ã‚¤ãƒˆãƒ«åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã«æŸ”è»Ÿãªå¹…ã‚’ä¸ãˆã‚‹ */
        .table-tasks thead th:first-child,
        .table-tasks tbody td:first-child {
            width: 100%; 
        }
        
        /* æœŸé™åˆ—ã®æœ€å°å¹…ã‚’ç¢ºä¿ã™ã‚‹CSS */
        .table-tasks thead th:nth-child(2), 
        .table-tasks tbody td:nth-child(2) {
            /* æ—¥ä»˜ã¨æ™‚åˆ»ãŒä¸¦ã¶ãŸã‚ã«å¿…è¦ãªæœ€å°é™ã®å¹…ï¼ˆä¾‹: 130pxï¼‰ã‚’ç¢ºä¿ */
            min-width: 155px; 
        }

        /* é€²æ—çŠ¶æ³åˆ—ã®æœ€å°å¹…ã‚’ç¢ºä¿ã™ã‚‹CSS */
        .table-tasks thead th:nth-child(3), 
        .table-tasks tbody td:nth-child(3) {
            min-width: 105px; /* ã€Œé€²æ—çŠ¶æ³ã€ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒåã¾ã‚‹å¹… */
        }

        /* å„ªå…ˆåº¦åˆ—ã®æœ€å°å¹…ã‚’ç¢ºä¿ã™ã‚‹CSS */
        .table-tasks thead th:nth-child(4), 
        .table-tasks tbody td:nth-child(4) {
            min-width: 90px; 
        }

        .table-tasks thead th a {
            white-space: nowrap;
        }

        /* ã‚¿ã‚¹ã‚¯åã‚»ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’æ‹¡å¼µã™ã‚‹ãŸã‚ã®CSS */
    /* è¦ªè¦ç´ ï¼ˆ<td>ï¼‰ã‚’ç›¸å¯¾ä½ç½®æŒ‡å®šã®åŸºæº–ã«ã™ã‚‹ */
    .table-tasks tbody td {
        position: relative;
    }

    /* ã‚¿ã‚¹ã‚¯åãƒªãƒ³ã‚¯ï¼ˆ<a>ï¼‰ã‚’ã‚»ãƒ«å…¨ä½“ã«åºƒã’ã‚‹ */
    .table-tasks tbody td a.stretched-link-task {
        /* Bootstrapã®stretched-linkã‚¯ãƒ©ã‚¹ã¨åŒç­‰ã®åŠ¹æœã‚’é©ç”¨ */
        position: static; /* æ—¢å­˜ã®ãƒªãƒ³ã‚¯ã®positionã‚’ãƒªã‚»ãƒƒãƒˆ */
    }

    /* Bootstrap 5 ã® stretched-link ã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ã†æ–¹ãŒè‰¯ã„ã§ã™ãŒã€
       å­˜åœ¨ã—ãªã„ç’°å¢ƒã®ãŸã‚ã«ã€æ“¬ä¼¼è¦ç´ ã‚’ä½¿ã£ã¦ã‚»ãƒ«å…¨ä½“ã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ */
    .table-tasks tbody td a.stretched-link-task::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«é…ç½® */
        pointer-events: auto; /* ã‚¯ãƒªãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
    }

    </style>


    {# ============================================================================== #}
    {# 4. ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« #}
    {# ============================================================================== #}
    {% if tasks %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-tasks">
                <thead>
                    <tr>
                        {# ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ãƒ«ãƒ¼ãƒ— (ã‚½ãƒ¼ãƒˆãƒªãƒ³ã‚¯ã®ç”Ÿæˆ) #}
                        {% with current_sort=current_sort_key current_order=current_order %}
                            
                            {% for key, label in sort_headers.items %}
                                <th scope="col">
                                    {# ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã¨ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å«ã‚€ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ #}
                                    {% if current_sort == key and current_order == 'asc' %}
                                        {# ç¾åœ¨ æ˜‡é †(asc) ã®å ´åˆ -> æ¬¡ã¯ é™é †(desc) #}
                                        {% with next_order='desc' %}
                                            <a href="?{% if current_search_query %}q={{ current_search_query }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}{% if current_status_filter %}status={{ current_status_filter }}&{% endif %}{% if current_priority_filter %}priority={{ current_priority_filter }}&{% endif %}sort={{ key }}&order={{ next_order }}" class="text-decoration-none text-dark d-flex align-items-center">
                                                {{ label }}
                                                <span class="ms-2">â–²</span> {# æ˜‡é †ã‚¢ã‚¤ã‚³ãƒ³ #}
                                            </a>
                                        {% endwith %}
                                        
                                    {% elif current_sort == key %}
                                        {# ç¾åœ¨ é™é †(desc) ã®å ´åˆ -> æ¬¡ã¯ æ˜‡é †(asc) #}
                                        {% with next_order='asc' %}
                                            <a href="?{% if current_search_query %}q={{ current_search_query }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}{% if current_status_filter %}status={{ current_status_filter }}&{% endif %}{% if current_priority_filter %}priority={{ current_priority_filter }}&{% endif %}sort={{ key }}&order={{ next_order }}" class="text-decoration-none text-dark d-flex align-items-center">
                                                {{ label }}
                                                <span class="ms-2">â–¼</span> {# é™é †ã‚¢ã‚¤ã‚³ãƒ³ #}
                                            </a>
                                        {% endwith %}
                                            
                                    {% else %}
                                        {# ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„åˆ—ã®å ´åˆ -> æ¬¡ã¯ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ˜‡é †(asc) #}
                                        {% with next_order='asc' %}
                                            <a href="?{% if current_search_query %}q={{ current_search_query }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}{% if current_status_filter %}status={{ current_status_filter }}&{% endif %}{% if current_priority_filter %}priority={{ current_priority_filter }}&{% endif %}sort={{ key }}&order={{ next_order }}" class="text-decoration-none text-dark d-flex align-items-center">
                                                {{ label }}
                                                {# ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ãªã— #}
                                            </a>
                                        {% endwith %}
                                    {% endif %}
                                </th>
                            {% endfor %}
                            
                        {% endwith %}
                        <th scope="col" class="text-nowrap">ã‚«ãƒ†ã‚´ãƒª</th>
                        <th scope="col" class="text-end text-nowrap">æ“ä½œ</th> {# æ“ä½œåˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ  #}
                    </tr>
                </thead>
                
                <tbody>
                    {# ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºãƒ«ãƒ¼ãƒ— #}
                    {% for task in tasks %}
                        <tr>
                            {# ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« (è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯) #}
                            <td>
                                <a href="{% url 'task_detail' task.pk %}" class="fw-bold text-decoration-none text-dark stretched-link-task">
                                    {{ task.title }}
                                </a>
                            </td>
                            
                            {# æœŸé™ (format: YYYY/MM/DD HH:MM) #}
                            <td class="text-nowrap">{{ task.due_date|date:"Y/m/d H:i"|default:"-" }}</td>
                            
                            {# é€²æ—çŠ¶æ³ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  #}
                            <td>
                                {# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã¯POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¡Œã„ã€å®Œäº†å¾Œã«ç¾åœ¨ã®ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ #}
                                <form action="{% url 'task_update_status' task.pk %}" method="post" class="status-update-form">
                                    {% csrf_token %}

                                    {# ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã® hidden input #}
                                    <input type="hidden" name="filter_params" value="{{ request.GET.urlencode }}">

                                    <div class="select-wrapper">
                                        {# å¤‰æ›´æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡ã—ã€è‰²ã‚’æ›´æ–°ã™ã‚‹JavaScriptã‚’å‘¼ã³å‡ºã™ #}
                                        <select name="new_status" class="status-select" onchange="updateSelectColor(this); this.form.submit()">
                                            {% for status_id, status_name in status_choices %}
                                                
                                                <option value="{{ status_id }}" 
                                                        {% if status_id == task.status %}selected{% endif %}
                                                        {# JavaScriptã§è‰²ä»˜ã‘ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿å±æ€§ #}
                                                        data-color="{% if status_id == 0 %}danger{% elif status_id == 1 %}warning{% else %}success{% endif %}">
                                                    {{ status_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </td>
                            
                            {# å„ªå…ˆåº¦ã®è¡¨ç¤º (ãƒãƒƒã‚¸) #}
                            <td>
                                {% if task.priority == 'high' %}
                                    <span class="badge bg-danger">é«˜</span>
                                {% elif task.priority == 'medium' %}
                                    <span class="badge bg-warning text-dark">ä¸­</span>
                                {% elif task.priority == 'low' %}
                                    <span class="badge bg-success">ä½</span>
                                {% else %}
                                    <span class="badge bg-secondary">ãªã—</span>
                                {% endif %}
                            </td>

                            {# ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤º (ãƒãƒƒã‚¸) #}
                            <td><span class="badge bg-info text-nowrap">{{ task.category.name|default:"ãªã—" }}</span></td>
                            
                            {# æ“ä½œãƒœã‚¿ãƒ³ #}
                            <td class="text-end text-nowrap">
                                {# ç·¨é›†ãƒœã‚¿ãƒ³ (TaskUpdateViewã¸é·ç§») #}
                                <a href="{% url 'task_update' task.pk %}" class="btn btn-sm btn-outline-warning me-2">ç·¨é›†</a>
                                
                                {# å‰Šé™¤ãƒœã‚¿ãƒ³ (TaskDeleteViewã¸POSTé€ä¿¡) #}
                                <form action="{% url 'task_delete' task.pk %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    
                                    {# å‰Šé™¤å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã¨ã—ã¦ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’æ¸¡ã™ #}
                                    <input type="hidden" name="filter_params" value="{{ request.GET.urlencode }}">
        
                                    <button type="submit" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" class="btn btn-sm btn-outline-danger">
                                        å‰Šé™¤
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        {# ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ #}
        <div class="alert alert-info">
            ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
    {% endif %}

    {# ============================================================================== #}
    {# 5. JavaScript: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®è‰²ä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯ #}
    {# ============================================================================== #}
    <script>
        // é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦selectãƒœãƒƒã‚¯ã‚¹ã®èƒŒæ™¯è‰²ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateSelectColor(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            // é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã® data-color å±æ€§ã‹ã‚‰è‰²ã‚’å–å¾—
            const color = selectedOption.getAttribute('data-color');
            
            // æ—¢å­˜ã®è‰²ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            selectElement.classList.remove('bg-danger-select', 'bg-warning-select', 'bg-success-select');
            
            // æ–°ã—ã„è‰²ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  (CSSã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®šç¾©)
            if (color) {
                selectElement.classList.add(`bg-${color}-select`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®è‰²ã‚’åˆæœŸè¨­å®šã™ã‚‹
        document.addEventListener('DOMContentLoaded', () => {
            const selectBoxes = document.querySelectorAll('.status-select');
            selectBoxes.forEach(selectElement => {
                updateSelectColor(selectElement);
            });
        });
    </script>

{% endblock content %}