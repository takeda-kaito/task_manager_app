{% extends "base.html" %}

{% block content %}

    <div class="mb-3">
        {# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æŒ¨æ‹¶è¡¨ç¤º #}
        <p class="lead">ã‚ˆã†ã“ãã€{{ user.username }}ã•ã‚“ï¼</p>
    </div>

    {# ============================================================================== #}
    {# 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¤œç´¢çª“ #}
    {# flex-nowrap ã«ã‚ˆã‚Šã€ã‚¹ãƒãƒ›ç”»é¢ã§ã‚‚ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ã¨ã€Œæ¤œç´¢ã€ãŒæ¨ªã«ä¸¦ã³ç¶šã‘ã¾ã™ #}
    {# ============================================================================== #}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-nowrap">
        <h1 class="mb-0 fs-4 text-nowrap me-2">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h1>
        
        <form method="get" action="{% url 'home' %}" class="flex-grow-1 d-flex justify-content-end" style="max-width: 250px;">
            <div class="input-group input-group-sm">
                <input 
                    type="search" 
                    name="q" 
                    class="form-control" 
                    placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." 
                    value="{{ current_search_query|default:'' }}"
                >
                <button class="btn btn-outline-secondary" type="submit">ğŸ”</button>
            </div>
            {# ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
            <input type="hidden" name="sort" value="{{ current_sort_key }}">
            <input type="hidden" name="order" value="{{ current_order }}">
        </form>
    </div>

    {# ============================================================================== #}
    {# 2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³: ã‚¿ã‚¹ã‚¯ä½œæˆ #}
    {# ============================================================================== #}
    <div class="mb-4">
        <a href="{% url 'task_create' %}" 
           class="btn btn-primary text-nowrap" 
           style="width: 180px; display: block; font-weight: 400;">
            + ã‚¿ã‚¹ã‚¯ã‚’æ–°è¦ä½œæˆ
        </a>
    </div>

    {# ============================================================================== #}
    {# 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ #}
    {# ============================================================================== #}
    <div class="mb-4">
        <form method="get" id="filter-form" class="d-flex align-items-center flex-nowrap overflow-auto pb-2">
            <span class="fw-bold small me-2 text-nowrap">ãƒ•ã‚£ãƒ«ã‚¿:</span>
            
            {# --- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ --- #}
            <div class="me-1">
                <select class="form-select form-select-sm" name="category" onchange="this.form.submit();" style="width: 110px; font-size: 0.75rem;">
                    <option value="">ã‚«ãƒ†ã‚´ãƒª</option> 
                    <option value="none" {% if current_category_filter == 'none' %}selected{% endif %}>ãªã—</option>
                    {% for category in categories %}
                        {# current_category_filter ã¨æ¯”è¼ƒã—ã¦ä¸€è‡´ã™ã‚Œã° selected ã‚’ä»˜ä¸ #}
                        <option value="{{ category.id }}" {% if category.id|stringformat:"s" == current_category_filter %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            {# --- é€²æ—çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ --- #}
            <div class="me-1">
                <select class="form-select form-select-sm" name="status" onchange="this.form.submit();" style="width: 100px; font-size: 0.75rem;">
                    <option value="">é€²æ—</option>
                    {% for status_id, status_name in status_choices %}
                        <option value="{{ status_id }}" {% if status_id|stringformat:"s" == current_status_filter %}selected{% endif %}>
                            {{ status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# --- å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ --- #}
            <div>
                <select class="form-select form-select-sm" name="priority" onchange="this.form.submit();" style="width: 85px; font-size: 0.75rem;">
                    <option value="">å„ªå…ˆåº¦</option>
                    {% for priority_id, priority_name in priority_choices %}
                        <option value="{{ priority_id }}" {% if priority_id|stringformat:"s" == current_priority_filter %}selected{% endif %}>
                            {{ priority_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# æ¡ä»¶ç¶­æŒç”¨ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
            <input type="hidden" name="q" value="{{ current_search_query|default:'' }}">
            <input type="hidden" name="sort" value="{{ current_sort_key }}">
            <input type="hidden" name="order" value="{{ current_order }}">
        </form>
    </div>

    <hr>

    {# ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ã‚¢ãƒ©ãƒ¼ãƒˆ (ã‚‚ã—ã‚ã‚Œã°è¡¨ç¤º) #}
    {% if current_category_filter or current_status_filter or current_priority_filter or current_search_query %}
        <div class="alert alert-warning py-2 mb-3 d-flex justify-content-between align-items-center">
            <span>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ä¸­</span>
            <a href="{% url 'home' %}" class="btn btn-sm btn-outline-dark">å…¨ã¦è§£é™¤</a>
        </div>
    {% endif %}

    {# ============================================================================== #}
    {# 4. ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« & ã‚«ã‚¹ã‚¿ãƒ CSS #}
    {# ============================================================================== #}
    <style>
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆJSã§å‹•çš„ã«è‰²å¤‰æ›´ï¼‰ */
        .status-select {
            padding: 0.25rem 0.5rem;
            padding-right: 1.5rem !important; 
            font-size: 0.85rem !important;
            background-color: transparent !important;
            color: #212529; 
            font-weight: bold;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            cursor: pointer;
            appearance: none;
            text-align: center;
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®èƒŒæ™¯è‰²å®šç¾© */
        .bg-danger-select { background-color: #dc3545 !important; color: white; }
        .bg-warning-select { background-color: #ffc107 !important; color: #212529; } 
        .bg-success-select { background-color: #198754 !important; color: white; }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å†…ã®çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³é…ç½® */
        .select-wrapper { position: relative; display: inline-block; }
        .select-wrapper::after {
            content: 'â–¼'; 
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            pointer-events: none; 
            font-size: 0.7em;
            color: inherit; 
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«å¹…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¾®èª¿æ•´ */
        .table-tasks thead th:first-child { width: 100%; }
        .table-tasks thead th:nth-child(2) { min-width: 155px; } /* æœŸé™åˆ— */
        .table-tasks thead th:nth-child(3) { min-width: 105px; } /* é€²æ—åˆ— */
        .table-tasks thead th:nth-child(4) { min-width: 90px; }  /* å„ªå…ˆåº¦åˆ— */

        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒªãƒ³ã‚¯ã‚’ã‚»ãƒ«å…¨ä½“ã«åºƒã’ã‚‹è¨­å®š */
        .table-tasks tbody td { position: relative; }
        .table-tasks tbody td a.stretched-link-task::after {
            content: "";
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            z-index: 1; pointer-events: auto;
        }
    </style>

    {% if tasks %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-tasks">
                <thead>
                    <tr>
                        {# ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ãƒ«ãƒ¼ãƒ— #}
                        {% with current_sort=current_sort_key current_order=current_order %}
                            {% for key, label in sort_headers.items %}
                                {# ğŸ’¡ text-nowrap ã‚’è¿½åŠ ã—ã¦ã€ã‚¹ãƒãƒ›ã§ã‚‚ã€Œã‚¿ã‚¹ã‚¯åã€ãŒæ”¹è¡Œã•ã‚Œãªã„ã‚ˆã†ã«å›ºå®š #}
                                <th scope="col" class="text-nowrap">
                                    <a href="?{% if current_search_query %}q={{ current_search_query }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}{% if current_status_filter %}status={{ current_status_filter }}&{% endif %}{% if current_priority_filter %}priority={{ current_priority_filter }}&{% endif %}sort={{ key }}&order={% if current_sort == key and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-dark d-flex align-items-center">
                                        {{ label }}
                                        {% if current_sort == key %}
                                            <span class="ms-1">{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>
                                        {% endif %}
                                    </a>
                                </th>
                            {% endfor %}
                        {% endwith %}
                        <th scope="col" class="text-nowrap">ã‚«ãƒ†ã‚´ãƒª</th>
                    </tr>
                </thead>
                
                <tbody>
                    {% for task in tasks %}
                        <tr>
                            <td>
                                <a href="{% url 'task_detail' task.pk %}" class="fw-bold text-decoration-none text-dark stretched-link-task">
                                    {{ task.title }}
                                </a>
                            </td>
                            <td class="text-nowrap">{{ task.due_date|date:"Y/m/d H:i"|default:"-" }}</td>
                            <td>
                                <form action="{% url 'task_update_status' task.pk %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="filter_params" value="{{ request.GET.urlencode }}">
                                    <div class="select-wrapper">
                                        <select name="new_status" class="status-select" onchange="updateSelectColor(this); this.form.submit()">
                                            {% for status_id, status_name in status_choices %}
                                                <option value="{{ status_id }}" {% if status_id == task.status %}selected{% endif %}
                                                        data-color="{% if status_id == 0 %}danger{% elif status_id == 1 %}warning{% else %}success{% endif %}">
                                                    {{ status_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </form>
                            </td>
                            <td>
                                {% if task.priority == 'high' %}<span class="badge bg-danger">é«˜</span>
                                {% elif task.priority == 'medium' %}<span class="badge bg-warning text-dark">ä¸­</span>
                                {% elif task.priority == 'low' %}<span class="badge bg-success">ä½</span>
                                {% else %}<span class="badge bg-secondary">ãªã—</span>{% endif %}
                            </td>
                            <td><span class="badge bg-info text-nowrap">{{ task.category.name|default:"ãªã—" }}</span></td>
                            <td class="text-end text-nowrap" style="position: relative; z-index: 2;">
                                <a href="{% url 'task_update' task.pk %}" class="btn btn-sm btn-outline-warning me-2">ç·¨é›†</a>
                                <form action="{% url 'task_delete' task.pk %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="filter_params" value="{{ request.GET.urlencode }}">
                                    <button type="submit" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" class="btn btn-sm btn-outline-danger">å‰Šé™¤</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    {% endif %}

    {# ============================================================================== #}
    {# 5. JavaScript: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†æ™‚ã®è‰²ä»˜ã‘ #}
    {# ============================================================================== #}
    <script>
        function updateSelectColor(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const color = selectedOption.getAttribute('data-color');
            selectElement.classList.remove('bg-danger-select', 'bg-warning-select', 'bg-success-select');
            if (color) selectElement.classList.add(`bg-${color}-select`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.status-select').forEach(updateSelectColor);
        });
    </script>

{% endblock content %}